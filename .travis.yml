sudo: false
language: c
branches:
  except:
    - /^[0-9]+\.[0-9]+\.[0-9]$/
matrix:
  include:
    - os: osx
      python: "2.6"
      env: TRAVIS_PYTHON_VERSION=2.6
    - os: osx
      python: "2.7"
      env: TRAVIS_PYTHON_VERSION=2.7
    - os: osx
      osx_image: xcode7.1
      python: "2.7"
      env: TRAVIS_PYTHON_VERSION=2.7
    - os: osx
      osx_image: xcode7.3
      python: "2.7"
      env: TRAVIS_PYTHON_VERSION=2.7
    - os: osx
      python: "3.5"
      env: TRAVIS_PYTHON_VERSION=3.5
    - os: osx
      python: "pypy"
      env: TRAVIS_PYTHON_VERSION=pypy
    - os: linux
      language: python
      python: "2.6"
    - os: linux
      language: python
      python: "2.7"
    - os: linux
      language: python
      python: "3.2"
    - os: linux
      language: python
      python: "3.3"
    - os: linux
      language: python
      python: "3.4"
    - os: linux
      language: python
      python: "3.5"
    - os: linux
      language: python
      python: "pypy"
install:
  - if [ "$TRAVIS_OS_NAME" == "osx" ]; then
        if [ "$TRAVIS_PYTHON_VERSION" == "pypy" ]; then
            echo "Updating homebrew";
            brew update;
            echo "Installing pypy";
            brew install pypy;
            echo "Installing flake8";
            /usr/local/bin/pip_pypy install flake8;
            echo "Installing asn1crypto";
            /usr/local/bin/pip_pypy install https://github.com/wbond/asn1crypto/archive/master.zip;
            export PYTHON_BIN=/usr/local/bin/pypy;
        else
            if [ "$TRAVIS_PYTHON_VERSION" == "3.5" ]; then
                echo "Updating homebrew";
                brew update;
                echo "Installing python3";
                brew install python3;
                echo "Installing flake8";
                /usr/local/bin/pip3 install flake8;
                echo "Installing asn1crypto";
                /usr/local/bin/pip3 install https://github.com/wbond/asn1crypto/archive/master.zip;
                export PYTHON_BIN=/usr/local/bin/python3;
            else
                if [ "$TRAVIS_PYTHON_VERSION" == "2.7" ]; then
                    echo "Installing pip";
                    curl --silent --show-error https://bootstrap.pypa.io/get-pip.py | sudo /usr/bin/python2.7;
                    echo "Installing flake8";
                    sudo /usr/bin/python2.7 -W ignore -c "import pip; pip.main(['--disable-pip-version-check', '--quiet', 'install', 'flake8'])";
                    echo "Installing asn1crypto";
                    sudo /usr/bin/python2.7 -W ignore -c "import pip; pip.main(['--disable-pip-version-check', '--quiet', 'install', 'https://github.com/wbond/asn1crypto/archive/master.zip'])";
                    export PYTHON_BIN=/usr/bin/python2.7;
                else
                    echo "Installing asn1crypto";
                    curl --silent --show-error --location -o asn1crypto-master.zip https://github.com/wbond/asn1crypto/archive/master.zip;
                    unzip asn1crypto-master.zip;
                    cd asn1crypto-master;
                    sudo /usr/bin/python2.6 setup.py install clean;
                    cd ..;
                    export PYTHON_BIN=/usr/bin/python2.6;
                fi
            fi
        fi
    else
        echo "Upgrading pip";
        python -c "import sys,pip; pip.main(['install', '--upgrade', 'pip' + ('==7.1.2' if sys.version_info[0:2] == (3, 2) else '')])";
        echo "Installing flake8";
        pip install flake8;
        echo "Installing asn1crypto";
        pip install https://github.com/wbond/asn1crypto/archive/master.zip;
        export PYTHON_BIN=python;
    fi
script:
  - $PYTHON_BIN run.py ci
